---

- name: delete old folder for display-controller
  file:
    path: /opt/display-controller
    state: absent

- name: download new controller version
  ansible.builtin.git:
    repo: https://github.com/ZoiosNET/ffw-ra-rauental-monitor.git
    dest: /opt/display-controller
    version: main
    clone: yes
    update: yes

- name: Send debug notification to Telegram
  community.general.telegram:
    token: "{{telegram_bot_token}}"
    api_args:
      chat_id: "{{telegram_chat_id}}"
      parse_mode: "markdown"
      text: "{{lookup('file', '/etc/hostname')}}: Contact server for monitor login key..."

- name: download monitor user auth key
  uri:
    url: http://divera.112-info.com/
    headers:
      x-api-key: "{{api_key}}"
    status_code: 200
    return_content: yes
  register: monitor_user_key

- name: Send debug notification to Telegram
  community.general.telegram:
    token: "{{telegram_bot_token}}"
    api_args:
      chat_id: "{{telegram_chat_id}}"
      parse_mode: "markdown"
      text: "{{lookup('file', '/etc/hostname')}}: Reposnse-Status of Server is {{monitor_user_key.status}}"

- name: populate monitor user auth key to /etc/environment
  lineinfile:
    path: "/etc/environment"
    state: present
    regexp: "^MonitorUserKey="
    line: "MonitorUserKey={{monitor_user_key.content}}"

- name: copy settings.propperties file
  template:
    src: templates/controller-settings.propperties.j2
    dest: /opt/display-controller/settings.propperties
    owner: root
    group: root
    mode: '0644'

- name: register display-controller service
  template:
    src: templates/display-controller.service.j2
    dest: /etc/systemd/system/display-controller.service
    owner: root
    group: root
    mode: '0755'

- name: enable and restart display-controller service
  service:
    name: display-controller.service
    enabled: yes
    daemon-reload: yes
    state: restarted
